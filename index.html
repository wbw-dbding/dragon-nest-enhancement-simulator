<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龍之谷　裝備強化模擬器V1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* Even darker background */
        }
        .animate-success {
            animation: glow-success 0.8s ease-out, pop-out 0.8s ease-out;
        }
        .animate-fail {
            animation: glow-fail 0.8s ease-out, shake-item 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        .item-glow-guaranteed {
            animation: glow-guaranteed 1.2s ease-out infinite;
        }
        .screen-shake {
            animation: screen-shake-fail 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        .effect-container {
            position: absolute;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            opacity: 0; /* Start hidden */
            animation: fade-out 0.8s ease-in forwards;
        }
        .effect-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255, 223, 128, 0.7) 0%, rgba(255, 223, 128, 0) 60%);
            transform: scale(0);
            animation: burst-scale 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        .effect-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                linear-gradient(white, white) no-repeat center/2px 100%,
                linear-gradient(white, white) no-repeat center/100% 2px;
            transform: scale(0) rotate(0deg);
            animation: lines-spin 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        @keyframes fade-out {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes burst-scale {
            from { transform: scale(0); }
            to { transform: scale(1.5); }
        }
        @keyframes lines-spin {
            from { transform: scale(0) rotate(0deg); }
            to { transform: scale(1.2) rotate(135deg); }
        }
        @keyframes glow-success {
            0% { box-shadow: 0 0 8px #a7f3d0, 0 0 16px #a7f3d0, 0 0 24px #34d399; }
            100% { box-shadow: 0 0 0px transparent, 0 0 0px transparent, 0 0 0px transparent; }
        }
        @keyframes glow-fail {
            0% { box-shadow: 0 0 8px #fecaca, 0 0 16px #fecaca, 0 0 24px #f87171; }
            100% { box-shadow: 0 0 0px transparent, 0 0 0px transparent, 0 0 0px transparent; }
        }
        @keyframes pop-out {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.15); }
        }
        @keyframes shake-item {
          10%, 90% { transform: translate3d(-1px, 0, 0) scale(1.05); }
          20%, 80% { transform: translate3d(2px, 0, 0) scale(1.05); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0) scale(1.05); }
          40%, 60% { transform: translate3d(4px, 0, 0) scale(1.05); }
        }
        @keyframes screen-shake-fail {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
          20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        @keyframes glow-guaranteed {
            0% { box-shadow: 0 0 10px #fcd34d, 0 0 20px #fcd34d, 0 0 30px #fbbf24; }
            50% { box-shadow: 0 0 20px #fcd34d, 0 0 30px #fcd34d, 0 0 40px #fbbf24; }
            100% { box-shadow: 0 0 10px #fcd34d, 0 0 20px #fcd34d, 0 0 30px #fbbf24; }
        }
        .gear-item.selected {
            background-color: #ca8a04; /* Darker yellow for selection */
            border-color: #facc15;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
        }
        .class-selector.active {
            background-color: #facc15;
            color: #111827;
        }
        .glow-indicator {
            background-color: #4b5563; /* Darker grey for +1~+3 */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .glow-green {
            background-color: #16a34a;
            box-shadow: 0 0 6px 1px #16a34a;
        }
        .glow-blue {
            background-color: #0ea5e9;
            box-shadow: 0 0 6px 1px #0ea5e9;
        }
        .glow-gold {
            background-color: #f59e0b;
            box-shadow: 0 0 6px 1px #f59e0b;
        }
        .glow-red {
            background-color: #ef4444;
            box-shadow: 0 0 8px 2px #ef4444; /* More intense glow for red */
        }
        .individual-reset-btn {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .gear-item:hover .individual-reset-btn {
            opacity: 1;
        }
        #left-gear-panel.disabled, #right-gear-panel.disabled {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="main-container" class="w-full max-w-7xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6 relative overflow-hidden">
        
        <p class="absolute top-3 left-4 text-L text-gray-400">作者：雷神之錘－蘋果咬一口</p>
        
        <header class="text-center pt-4">
            <h1 class="text-3xl md:text-4xl font-bold text-yellow-400 tracking-wider">龍之谷　裝備強化模擬器V1.1</h1>
            <p class="text-gray-400 mt-2">點選一件裝備，開始你的強化之路</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            
            <!-- Gear & Mannequin Panels -->
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div id="left-gear-panel" class="space-y-3 transition-opacity"></div>
                <div class="hidden md:flex flex-col items-center justify-center space-y-4 p-4 bg-gray-900/50 rounded-xl">
                    <div id="mannequin-display" class="w-full h-64 flex items-center justify-center"></div>
                    <div class="grid grid-cols-2 gap-2 w-full">
                        <button data-class="warrior" class="class-selector w-full p-2 rounded-md bg-gray-700 hover:bg-yellow-500 hover:text-black transition-colors">戰士</button>
                        <button data-class="archer" class="class-selector w-full p-2 rounded-md bg-gray-700 hover:bg-yellow-500 hover:text-black transition-colors">弓箭手</button>
                        <button data-class="sorceress" class="class-selector w-full p-2 rounded-md bg-gray-700 hover:bg-yellow-500 hover:text-black transition-colors">法師</button>
                        <button data-class="cleric" class="class-selector w-full p-2 rounded-md bg-gray-700 hover:bg-yellow-500 hover:text-black transition-colors">牧師</button>
                    </div>
                </div>
                <div id="right-gear-panel" class="space-y-3 transition-opacity"></div>
            </div>

            <!-- Control & Info Panel -->
            <div class="bg-gray-900/50 rounded-xl p-6 space-y-4 flex flex-col justify-between">
                <div>
                    <div class="border-b border-gray-700 pb-2 mb-3">
                        <h2 class="text-xl font-semibold text-center text-gray-300">強化資訊</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                             <p class="text-lg text-gray-400">當前選擇:</p>
                             <p id="selected-item-name" class="font-bold text-yellow-300 text-xl truncate"></p>
                            <p class="text-lg text-gray-400 mt-2">下一級成功率</p>
                            <p id="success-rate" class="text-5xl font-bold text-green-400">100%</p>
                        </div>
                        <div class="space-y-3 flex flex-col">
                            <div class="flex justify-between items-center bg-gray-800 p-2 rounded-md text-sm">
                                <p class="text-gray-400">失敗次數:</p>
                                <span id="item-failures" class="font-bold text-red-400 text-base">0</span>
                            </div>
                            <div class="flex flex-col items-center bg-gray-800 p-2 rounded-md flex-grow justify-center">
                                <label for="use-jelly" class="font-medium text-yellow-300 text-sm leading-tight text-center">柏林的鍛造卷</label>
                                <small class="text-gray-500 font-normal mb-1">勾選使用</small>
                                <input id="use-jelly" type="checkbox" class="h-6 w-6 rounded text-yellow-500 bg-gray-700 border-gray-600 focus:ring-yellow-600 disabled:opacity-50 flex-shrink-0">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-lg text-gray-400 text-center mb-2">充能值</p>
                        <div class="w-full bg-gray-700 rounded-full h-6">
                            <div id="charge-bar" class="bg-gradient-to-r from-sky-500 to-indigo-500 h-6 rounded-full text-center text-white font-bold text-sm leading-6 transition-all duration-500" style="width: 0%;">0.0%</div>
                        </div>
                        <p id="charge-info" class="text-center text-sm text-gray-500 mt-1 h-5 flex items-center justify-center"></p>
                    </div>
                </div>
                
                <div class="w-full space-y-4">
                    <button id="enhance-button" class="w-full bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-600 hover:to-amber-700 text-white font-bold text-xl py-4 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-400/50">
                        開始強化
                    </button>
                    <div class="bg-gray-800 p-3 rounded-lg space-y-3">
                        <h3 class="text-center text-lg font-semibold text-gray-400 border-b border-gray-700 pb-2">工具 & 自動化</h3>
                        <div class="flex items-center justify-between gap-2">
                             <label for="target-level" class="font-medium text-green-300 whitespace-nowrap">自動目標:</label>
                             <input id="target-level" type="number" min="1" max="15" value="10" class="bg-gray-900 text-white w-full text-center rounded-md p-1">
                             <button id="auto-enhance-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg whitespace-nowrap">開始</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="set-all-plus-8-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">全身+8</button>
                            <button id="reset-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">全身重置</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="bg-gray-900/50 rounded-xl p-4 space-y-2">
             <h2 class="text-xl font-semibold text-center text-gray-300 border-b border-gray-700 pb-2">強化日誌</h2>
            <div id="log-container" class="h-40 bg-gray-900 rounded-lg p-3 overflow-y-auto text-sm space-y-1">
                <p class="text-gray-500">點擊 "開始強化" 來記錄你的傳奇...</p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const mainContainer = document.getElementById('main-container');
        const leftGearPanel = document.getElementById('left-gear-panel');
        const rightGearPanel = document.getElementById('right-gear-panel');
        const mannequinDisplay = document.getElementById('mannequin-display');
        const classSelectors = document.querySelectorAll('.class-selector');
        const selectedItemNameEl = document.getElementById('selected-item-name');
        const useJellyCheckbox = document.getElementById('use-jelly');
        const enhanceButton = document.getElementById('enhance-button');
        const resetButton = document.getElementById('reset-button');
        const setAllPlus8Button = document.getElementById('set-all-plus-8-button');
        const successRateEl = document.getElementById('success-rate');
        const chargeBarEl = document.getElementById('charge-bar');
        const chargeInfoEl = document.getElementById('charge-info');
        const logContainer = document.getElementById('log-container');
        const itemFailuresEl = document.getElementById('item-failures');
        const targetLevelInput = document.getElementById('target-level');
        const autoEnhanceButton = document.getElementById('auto-enhance-button');

        // --- Game Data ---
        const GEAR_SETUP = {
            left: [
                { id: 'head', name: '頭盔' }, { id: 'body', name: '上衣' }, { id: 'pants', name: '褲子' },
                { id: 'gloves', name: '手套' }, { id: 'boots', name: '鞋子' },
            ],
            right: [
                { id: 'necklace', name: '項鍊' }, { id: 'earring', name: '耳環' }, { id: 'ring1', name: '戒指' }, { id: 'ring2', name: '戒指' }, 
                { id: 'main-weapon', name: '主武器' }, { id: 'sub-weapon', 'name': '副武器' },
            ]
        };
        const ALL_GEAR_IDS = [...GEAR_SETUP.left.map(g => g.id), ...GEAR_SETUP.right.map(g => g.id)];
        const ENHANCEMENT_RATES = {
            1: 100, 2: 100, 3: 100, 4: 90, 5: 70, 6: 60, 7: 20, 8: 15,
            9: 12, 10: 10, 11: 8, 12: 6, 13: 3, 14: 2, 15: 1,
        };
        const MAX_LEVEL = 15;
        const CLASS_SVGS = {
            warrior: `<svg class="w-48 h-48 text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.16L8.25 5H7.13c-1.3 0-2.38.94-2.6 2.2L3 17.87V22h7v-4h4v4h7v-4.13l-1.53-10.67c-.22-1.26-1.3-2.2-2.6-2.2h-1.13L12 2.16zM12 4.5l2.25 2H9.75L12 4.5zM8.5 8h7c.41 0 .75.34.75.75s-.34.75-.75.75h-7c-.41 0-.75-.34-.75-.75S8.09 8 8.5 8zM7 19v-5h10v5H7z"/></svg>`,
            archer: `<svg class="w-48 h-48 text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-1.1 0-2 .9-2 2v1H9c-1.1 0-2 .9-2 2v2c0 .55.45 1 1 1s1-.45 1-1V7h2v12H9v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-2c0-.55-.45-1-1-1s-1 .45-1 1v2h-2V7h2v2c0 .55.45 1 1 1s1-.45 1-1V7c0-1.1-.9-2-2-2h-1V4c0-1.1-.9-2-2-2zm7 9l-2 2v2l2 2 2-2v-2l-2-2zM5 11l-2 2v2l2 2 2-2v-2l-2-2z"/></svg>`,
            sorceress: `<svg class="w-48 h-48 text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l-3 6-6 3 6 3 3 6 3-6 6-3-6-3-3-6zm0 4.5l1.5 3 3 1.5-3 1.5-1.5 3-1.5-3-3-1.5 3-1.5L12 6.5zM20 16l-2 1-1 2-1-2-2-1 2-1 1-2 1 2 2 1zM4 18l-2 1-1 2-1-2-2-1 2-1 1-2 1 2 2 1z"/></svg>`,
            cleric: `<svg class="w-48 h-48 text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h4v2h-4v4h-2v-4H7v-2h4v-4z"/></svg>`
        };
        const GEAR_ICONS = {
            head: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.6,14.2c-0.8-1-1.2-2.3-1.2-3.6V8.4c0-3.3-2.2-6.2-5.4-6.2S8.6,5.1,8.6,8.4v2.2c0,1.3-0.4,2.6-1.2,3.6 C6.6,15.1,6,16.5,6,18v0.8c0,1.1,0.9,2,2,2h8c1.1,0,2-0.9,2-2V18C18,16.5,17.4,15.1,16.6,14.2z" /></svg>`,
            body: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12,3L6,4.5v5.7c0,4.8,5.1,9.3,6,9.3s6-4.5,6-9.3V4.5L12,3z M12,17.8c-0.6,0-4-3.1-4-7.6V6.3l4-1.2l4,1.2v3.9 C16,14.7,12.6,17.8,12,17.8z" /></svg>`,
            pants: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8,2v20h2V12h4v10h2V2H8z" /></svg>`,
            gloves: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.9,8.4c0-2.8-2.3-5.1-5.1-5.1S6.6,5.6,6.6,8.4v4.2c0,2.8,2.3,5.1,5.1,5.1s5.1-2.3,5.1-5.1V8.4z M15.4,12.6 c0,2-1.6,3.6-3.6,3.6s-3.6-1.6-3.6-3.6V8.4c0-2,1.6-3.6,3.6-3.6s3.6,1.6,3.6,3.6V12.6z" /></svg>`,
            boots: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M18,21H8c-1.1,0-2-0.9-2-2V11c0-1.1,0.9-2,2-2h10v12H18z M10,11v8 M14,11v8" /></svg>`,
            ring1: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8S16.4,4,12,4z M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18z M12,9l-2,3l2,3l2-3L12,9z" /></svg>`,
            ring2: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8S16.4,4,12,4z M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18z M12,9l-2,3l2,3l2-3L12,9z" /></svg>`,
            necklace: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4,9c0-4.4,3.6-8,8-8s8,3.6,8,8c0,2.1-0.8,4-2.2,5.5L12,22l-5.8-7.5C4.8,13,4,11.1,4,9z M12,12c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3S13.7,12,12,12z" /></svg>`,
            earring: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10c0.8,0,1.5-0.1,2.2-0.3 M12,6c-3.3,0-6,2.7-6,6s2.7,6,6,6" /></svg>`,
            'main-weapon': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21,3L3,21 M16,3h2v2h-2V3z M19,6h2v2h-2V6z M6,19H4v-2h2V19z M9,16H7v-2h2V16z M12,13l-3,3l-1.4-1.4l3-3L12,13z M18,7l-1.4-1.4l-7.1,7.1L11,14L18,7z" /></svg>`,
            'sub-weapon': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12,2L4,5v6c0,5,8,10,8,10s8-5,8-10V5L12,2z" /></svg>`
        };

        // --- Game State ---
        let gearState = {};
        let selectedItemId = GEAR_SETUP.left[0].id;
        let isAutoEnhancing = false;

        // --- Functions ---
        function initializeState() {
            ALL_GEAR_IDS.forEach(id => {
                gearState[id] = { level: 0, charge: 0.0, failures: 0 };
            });
        }

        function createGearItem(item) {
            const itemEl = document.createElement('div');
            itemEl.id = `item-${item.id}`;
            itemEl.dataset.itemId = item.id;
            itemEl.className = 'gear-item relative border-2 border-gray-600 bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer transition-all duration-200 hover:bg-gray-600';
            
            const glowIndicator = document.createElement('div');
            glowIndicator.id = `glow-${item.id}`;
            glowIndicator.className = 'glow-indicator w-3 h-3 rounded-full mr-2 flex-shrink-0';

            const iconContainer = document.createElement('div');
            iconContainer.id = `icon-${item.id}`;
            iconContainer.innerHTML = GEAR_ICONS[item.id] || '';
            iconContainer.className = 'mr-2 flex-shrink-0';
            
            const nameAndLevelContainer = document.createElement('div');
            nameAndLevelContainer.className = 'flex-grow flex justify-between items-center';

            const itemName = document.createElement('span');
            itemName.className = 'font-semibold text-lg text-gray-300';
            itemName.textContent = item.name;
            
            const levelContainer = document.createElement('div');
            levelContainer.className = 'flex items-center flex-shrink-0';
            
            const itemLevel = document.createElement('span');
            itemLevel.id = `level-${item.id}`;
            itemLevel.className = 'font-bold text-2xl text-gray-400';
            itemLevel.textContent = '+0';
            
            const individualResetBtn = document.createElement('button');
            individualResetBtn.innerHTML = '&#x21BA;'; // Reset symbol
            individualResetBtn.dataset.resetId = item.id;
            individualResetBtn.className = 'individual-reset-btn text-gray-500 hover:text-red-400 ml-2 text-xl font-bold';

            levelContainer.appendChild(itemLevel);
            levelContainer.appendChild(individualResetBtn);
            
            nameAndLevelContainer.appendChild(itemName);
            nameAndLevelContainer.appendChild(levelContainer);

            itemEl.appendChild(glowIndicator);
            itemEl.appendChild(iconContainer);
            itemEl.appendChild(nameAndLevelContainer);
            
            return itemEl;
        }

        function setupGearPanels() {
            leftGearPanel.innerHTML = '';
            GEAR_SETUP.left.forEach(item => leftGearPanel.appendChild(createGearItem(item)));

            rightGearPanel.innerHTML = '';
            GEAR_SETUP.right.forEach(item => rightGearPanel.appendChild(createGearItem(item)));
        }

        function setupMannequin() {
            mannequinDisplay.innerHTML = '';
            Object.keys(CLASS_SVGS).forEach(className => {
                const svgContainer = document.createElement('div');
                svgContainer.id = `class-svg-${className}`;
                svgContainer.innerHTML = CLASS_SVGS[className];
                svgContainer.classList.add('hidden');
                mannequinDisplay.appendChild(svgContainer);
            });
            switchClass('warrior');
        }

        function switchClass(className) {
            Object.keys(CLASS_SVGS).forEach(key => {
                document.getElementById(`class-svg-${key}`).classList.add('hidden');
            });
            document.getElementById(`class-svg-${className}`).classList.remove('hidden');
            classSelectors.forEach(selector => {
                selector.classList.toggle('active', selector.dataset.class === className);
            });
        }
        
        function getLevelColorClass(level) {
            if (level >= 14) return 'text-red-500';
            if (level >= 10) return 'text-yellow-400';
            if (level >= 7) return 'text-cyan-400';
            if (level >= 1) return 'text-green-400';
            return 'text-gray-400';
        }

        function getGlowColorClass(level) {
            if (level >= 13) return 'glow-red';
            if (level >= 10) return 'glow-gold';
            if (level >= 7) return 'glow-blue';
            if (level >= 4) return 'glow-green';
            return '';
        }

        function updateUI() {
            ALL_GEAR_IDS.forEach(id => {
                const item = gearState[id];
                const itemEl = document.getElementById(`item-${id}`);
                const levelEl = document.getElementById(`level-${id}`);
                levelEl.textContent = `+${item.level}`;
                levelEl.className = 'font-bold text-2xl transition-colors duration-300 ' + getLevelColorClass(item.level);
                
                const glowEl = document.getElementById(`glow-${id}`);
                const glowClass = getGlowColorClass(item.level);
                glowEl.className = 'glow-indicator w-3 h-3 rounded-full mr-2 flex-shrink-0';
                if (glowClass) glowEl.classList.add(glowClass);
                itemEl.classList.remove('item-glow-guaranteed');
                itemEl.classList.toggle('selected', id === selectedItemId);
            });

            const selectedItem = gearState[selectedItemId];
            const selectedItemInfo = [...GEAR_SETUP.left, ...GEAR_SETUP.right].find(g => g.id === selectedItemId);
            selectedItemNameEl.textContent = selectedItemInfo.name;
            chargeInfoEl.classList.remove('text-yellow-400', 'font-bold');
            useJellyCheckbox.disabled = selectedItem.level < 3;
            if(useJellyCheckbox.disabled) useJellyCheckbox.checked = false;

            if (selectedItem.level >= MAX_LEVEL) {
                successRateEl.textContent = 'MAX';
                successRateEl.classList.remove('text-green-400');
                successRateEl.classList.add('text-yellow-400');
                enhanceButton.disabled = true;
                enhanceButton.textContent = '已達最高等級';
                enhanceButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                const targetLevel = selectedItem.level + 1;
                const baseRate = ENHANCEMENT_RATES[targetLevel] || 0;
                const useJelly = useJellyCheckbox.checked && !useJellyCheckbox.disabled;
                const actualRate = useJelly ? Math.min(baseRate * 2, 100) : baseRate;
                successRateEl.textContent = `${actualRate}%`;
                successRateEl.classList.add('text-green-400');
                successRateEl.classList.remove('text-yellow-400');
                enhanceButton.disabled = false;
                enhanceButton.textContent = '開始強化';
                enhanceButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            const chargePercentage = Math.min(selectedItem.charge, 100);
            chargeBarEl.style.width = `${chargePercentage}%`;
            chargeBarEl.textContent = `${selectedItem.charge.toFixed(1)}%`;
            
            if (selectedItem.charge >= 100) {
                document.getElementById(`item-${selectedItemId}`).classList.add('item-glow-guaranteed');
                chargeInfoEl.classList.add('text-yellow-400', 'font-bold');
                chargeInfoEl.textContent = '充能完畢！下次強化 100% 成功！';
            } else {
                 chargeInfoEl.textContent = '充能值滿100%時，下次強化必定成功！';
            }
            itemFailuresEl.textContent = selectedItem.failures;
        }
        
        function logMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            switch(type) {
                case 'success': p.className = 'text-green-400'; break;
                case 'fail': p.className = 'text-red-400'; break;
                case 'guaranteed': p.className = 'text-yellow-400 font-bold'; break;
                default: p.className = 'text-gray-400'; break;
            }
            if (logContainer.children.length === 1 && logContainer.children[0].textContent.includes('傳奇')) {
                logContainer.innerHTML = '';
            }
            logContainer.prepend(p);
        }

        function triggerSuccessEffect(element) {
            const rect = element.getBoundingClientRect();
            const containerRect = mainContainer.getBoundingClientRect();
            
            const effect = document.createElement('div');
            effect.className = 'effect-container';
            effect.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
            effect.style.top = `${rect.top - containerRect.top + rect.height / 2}px`;
            
            mainContainer.appendChild(effect);

            setTimeout(() => {
                effect.remove();
            }, 800);
        }

        function handleEnhance() {
            const itemToEnhance = gearState[selectedItemId];
            if (itemToEnhance.level >= MAX_LEVEL) return;

            const targetLevel = itemToEnhance.level + 1;
            const baseRate = ENHANCEMENT_RATES[targetLevel] || 0;
            const useJelly = useJellyCheckbox.checked && !useJellyCheckbox.disabled;
            const actualRate = useJelly ? Math.min(baseRate * 2, 100) : baseRate;
            const isGuaranteed = itemToEnhance.charge >= 100;
            const randomChance = Math.random() * 100;
            const itemName = [...GEAR_SETUP.left, ...GEAR_SETUP.right].find(g => g.id === selectedItemId).name;
            let success = false;
            let logMsg = `[${itemName} +${itemToEnhance.level} → +${targetLevel}] 嘗試強化... (成功率: ${actualRate}%)`;
            
            if (isGuaranteed) {
                success = true;
                itemToEnhance.charge -= 100;
                logMessage(logMsg, 'info');
                logMessage(`✨ [${itemName}] 充能爆發！強化必定成功！`, 'guaranteed');
            } else if (randomChance < actualRate) {
                success = true;
                logMessage(logMsg, 'info');
                logMessage(`[成功] 恭喜！[${itemName}] 強化至 +${targetLevel}！`, 'success');
            } else {
                success = false;
                const chargeGained = baseRate * 0.6; 
                itemToEnhance.charge += chargeGained;
                itemToEnhance.failures++;
                logMessage(logMsg, 'info');
                logMessage(`[失敗] [${itemName}] 強化失敗。獲得充能值 ${chargeGained.toFixed(1)}%。`, 'fail');
            }

            const itemEl = document.getElementById(`item-${selectedItemId}`);
            if (success) {
                itemToEnhance.level++;
                itemToEnhance.charge *= 0.6;
                itemEl.classList.add('animate-success');
                triggerSuccessEffect(itemEl);
            } else {
                itemEl.classList.add('animate-fail');
                mainContainer.classList.add('screen-shake');
            }
            
            setTimeout(() => {
                itemEl.classList.remove('animate-success', 'animate-fail');
                mainContainer.classList.remove('screen-shake');
                updateUI();
            }, 800);
        }

        function handlePanelClick(event) {
            const target = event.target;
            const gearItem = target.closest('.gear-item');
            if (!gearItem) return;
            const itemId = gearItem.dataset.itemId;

            if (target.matches('.individual-reset-btn')) {
                const itemName = [...GEAR_SETUP.left, ...GEAR_SETUP.right].find(g => g.id === itemId).name;
                gearState[itemId] = { level: 0, charge: 0, failures: 0 };
                logMessage(`[${itemName}] 已重置為 +0`, 'info');
            } else {
                selectedItemId = itemId;
            }
            updateUI();
        }

        function handleResetAll() {
            initializeState();
            logMessage('所有裝備已重置為 +0', 'info');
            updateUI();
        }

        function handleSetAllPlus8() {
            ALL_GEAR_IDS.forEach(id => {
                gearState[id] = { level: 8, charge: 0, failures: 0 };
            });
            logMessage('所有裝備已設定為 +8', 'info');
            updateUI();
        }

        function toggleAutoEnhanceUI(isBusy) {
            enhanceButton.disabled = isBusy;
            resetButton.disabled = isBusy;
            setAllPlus8Button.disabled = isBusy;
            targetLevelInput.disabled = isBusy;
            leftGearPanel.classList.toggle('disabled', isBusy);
            rightGearPanel.classList.toggle('disabled', isBusy);

            if (isBusy) {
                autoEnhanceButton.textContent = '停止';
                autoEnhanceButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                autoEnhanceButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            } else {
                autoEnhanceButton.textContent = '開始';
                autoEnhanceButton.classList.add('bg-green-600', 'hover:bg-green-700');
                autoEnhanceButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            }
        }

        async function startAutoEnhance() {
            isAutoEnhancing = true;
            toggleAutoEnhanceUI(true);
            const targetLevel = parseInt(targetLevelInput.value, 10);
            const itemName = [...GEAR_SETUP.left, ...GEAR_SETUP.right].find(g => g.id === selectedItemId).name;
            logMessage(`[${itemName}] 開始自動強化至 +${targetLevel}`, 'info');

            while (isAutoEnhancing && gearState[selectedItemId].level < targetLevel && gearState[selectedItemId].level < MAX_LEVEL) {
                handleEnhance();
                await new Promise(resolve => setTimeout(resolve, 850)); // Delay slightly longer than animation
            }

            if (gearState[selectedItemId].level >= targetLevel) {
                logMessage(`[${itemName}] 自動強化成功！已達到 +${gearState[selectedItemId].level}`, 'success');
            } else if (!isAutoEnhancing) {
                logMessage(`[${itemName}] 自動強化已手動停止。`, 'info');
            }
            isAutoEnhancing = false;
            toggleAutoEnhanceUI(false);
        }

        function handleAutoEnhanceToggle() {
            if (isAutoEnhancing) {
                isAutoEnhancing = false;
            } else {
                startAutoEnhance();
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            initializeState();
            setupGearPanels();
            setupMannequin();
            updateUI();
            
            enhanceButton.addEventListener('click', handleEnhance);
            resetButton.addEventListener('click', handleResetAll);
            setAllPlus8Button.addEventListener('click', handleSetAllPlus8);
            autoEnhanceButton.addEventListener('click', handleAutoEnhanceToggle);
            useJellyCheckbox.addEventListener('change', updateUI);
            classSelectors.forEach(selector => selector.addEventListener('click', (e) => switchClass(e.target.dataset.class)));
            leftGearPanel.addEventListener('click', handlePanelClick);
            rightGearPanel.addEventListener('click', handlePanelClick);
        };
    </script>
</body>
</html>
